<!DOCTYPE html>
<html>
    <!-- title -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="Camper">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Camper">
    <meta name="keywords" content="Camper | Camper">
    <meta name="description" content="">
    <meta name="Cache-Control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>iptables简单入门 · Camper&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s 1;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= /css/style.css?v=20180709 as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= /css/mobile.css?v=20180709 media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/favicon.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >Camper&#39;s Blog.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">iptables简单入门</a>
            </div>
    </div>
    
    <a class="home-link" href=/>Camper's Blog.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style=








height:50vh;

>
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            iptables简单入门
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count">5,693</span> / Reading time: <span class="post-count">28 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2018/09/12</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h2 id="预热：请看上一篇–网络基础"><a href="#预热：请看上一篇–网络基础" class="headerlink" title="预热：请看上一篇–网络基础"></a>预热：请看上一篇–网络基础</h2><p><strong>思考：</strong></p>
<p>什么是交换,什么是路由,什么是路由表？</p>
<p>交换是指同网络访问（两台机器连在同一个交换机上，配置同网段的不同ip就可以直接通迅)<br>路由就是跨网络访问(路径选择）<br>路由表是记录路由信息的表</p>
<h3 id="一、查看路由表信息"><a href="#一、查看路由表信息" class="headerlink" title="一、查看路由表信息"></a>一、查看路由表信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//route命令用来查看和设置路由表信息</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># route -n		//查看路由表信息</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">192.168</span>.<span class="number">0.0</span>     <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth1</span><br><span class="line"><span class="number">10.1</span>.<span class="number">1.0</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">10.1</span>.<span class="number">1.254</span>      <span class="number">0.0</span>.<span class="number">0.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line">目标网络		网关			 子网掩码		 路由标志				 网卡</span><br><span class="line">											Up:启动状态</span><br><span class="line">											UG:该网关为路由器</span><br></pre></td></tr></table></figure>
<h3 id="二、IP路由选择实验"><a href="#二、IP路由选择实验" class="headerlink" title="二、IP路由选择实验"></a>二、IP路由选择实验</h3><h4 id="1-route相关命令"><a href="#1-route相关命令" class="headerlink" title="1. route相关命令"></a>1. route相关命令</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route -n  查看路由,显示ip,不解析</span><br><span class="line">route del default    删除默认路由</span><br><span class="line">route add default gw <span class="number">192.168</span>.<span class="number">1.110</span>    添加一个默认网关，把所有不知道的网络交给网关来转发</span><br><span class="line">rouate add -net <span class="number">192.168</span>.<span class="number">2.0</span>/<span class="number">24</span> dev eth0		对一个网络添加一个新的路由（另一个网段）</span><br><span class="line">route add -host <span class="number">192.168</span>.<span class="number">3.1</span> gw <span class="number">192.168</span>.<span class="number">1.110</span>  	对一个具体的ip添加路由</span><br></pre></td></tr></table></figure>
<h4 id="2-实验需求"><a href="#2-实验需求" class="headerlink" title="2. 实验需求"></a>2. 实验需求</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">环境准备：</span><br><span class="line">node1:<span class="number">10.1</span>.<span class="number">1.1</span>和<span class="number">192.168</span>.<span class="number">0.1</span>  作为网关服务器，开启路由转发功能/proc/sys/net/ipv4/ip_forward</span><br><span class="line">node2:<span class="number">172.16</span>.<span class="number">0.254</span>		</span><br><span class="line">node3:<span class="number">10.12</span>.<span class="number">0.254</span></span><br><span class="line">要求：</span><br><span class="line">实现不同网络(<span class="number">10.12</span>.<span class="number">0.0</span>/<span class="number">24</span>和<span class="number">172.16</span>.<span class="number">0.254</span>/<span class="number">24</span>)之间的互通，使用第三方主机node1作为路由进行转发</span><br></pre></td></tr></table></figure>
<h4 id="3-具体步骤"><a href="#3-具体步骤" class="headerlink" title="3. 具体步骤"></a>3. 具体步骤</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. node2上配置<span class="number">172.16</span>.<span class="number">0.254</span>的静态IP地址</span><br><span class="line">略</span><br><span class="line"></span><br><span class="line">添加默认路由网关：</span><br><span class="line"><span class="comment"># route add -net 10.1.1.0/24 dev eth0</span></span><br><span class="line"><span class="comment"># route add default gw 10.1.1.1</span></span><br><span class="line"></span><br><span class="line">验证：</span><br><span class="line">[root@node2 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">172.16</span>.<span class="number">0.0</span>      <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">10.1</span>.<span class="number">1.0</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">10.1</span>.<span class="number">1.1</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. node3上配置<span class="number">10.12</span>.<span class="number">0.254</span>的静态IP地址</span><br><span class="line">[root@node3 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=<span class="number">10.12</span>.<span class="number">0.254</span></span><br><span class="line">NETMASK=<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">GATEWAY=<span class="number">10.1</span>.<span class="number">1.1</span></span><br><span class="line"></span><br><span class="line">验证：</span><br><span class="line">[root@node3 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">10.1</span>.<span class="number">1.1</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.255</span> UH    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">10.12</span>.<span class="number">0.0</span>       <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">1</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">10.1</span>.<span class="number">1.1</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 在node1上开启路由转发的功能</span><br><span class="line"><span class="number">1</span>) 临时开启</span><br><span class="line">[root@node1 ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_forward </span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward </span></span><br><span class="line">[root@node1 ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_forward </span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">注意：如果重启网络，失效</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 永久开启</span><br><span class="line">[root@node1 ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># Controls IP packet forwarding</span></span><br><span class="line">net.ipv4.ip_forward = <span class="number">0</span>		<span class="number">0</span>代表不开启路由转发；<span class="number">1</span>代表开启转发</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 在node1上增加<span class="number">2</span>条分别到达node2和node3的路由信息</span><br><span class="line">[root@node1 ~]<span class="comment"># route add -net 172.16.0.0/24 dev eth0	</span></span><br><span class="line">[root@node1 ~]<span class="comment"># route add -net 10.12.0.0/24 dev eth0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">172.16</span>.<span class="number">0.0</span>      <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">10.12</span>.<span class="number">0.0</span>       <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">192.168</span>.<span class="number">0.0</span>     <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth1</span><br><span class="line"><span class="number">10.1</span>.<span class="number">1.0</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>     <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">0.0</span>     U     <span class="number">1002</span>   <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>     <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">0.0</span>     U     <span class="number">1003</span>   <span class="number">0</span>        <span class="number">0</span> eth1</span><br><span class="line"><span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">10.1</span>.<span class="number">1.254</span>      <span class="number">0.0</span>.<span class="number">0.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>. 测试验证</span><br><span class="line">node1：</span><br><span class="line">[root@node1 ~]<span class="comment"># ping 172.16.0.254</span></span><br><span class="line">PING <span class="number">172.16</span>.<span class="number">0.254</span> (<span class="number">172.16</span>.<span class="number">0.254</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.16</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">2.83</span> ms</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># ping 10.12.0.254</span></span><br><span class="line">PING <span class="number">10.12</span>.<span class="number">0.254</span> (<span class="number">10.12</span>.<span class="number">0.254</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.12</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">1.10</span> ms</span><br><span class="line"></span><br><span class="line">node2：访问node3主机</span><br><span class="line">[root@node2 ~]<span class="comment"># ping 10.12.0.254</span></span><br><span class="line">PING <span class="number">10.12</span>.<span class="number">0.254</span> (<span class="number">10.12</span>.<span class="number">0.254</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line">From <span class="number">10.1</span>.<span class="number">1.1</span>: icmp_seq=<span class="number">1</span> Redirect Host(New nexthop: <span class="number">10.12</span>.<span class="number">0.254</span>)</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.12</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.624</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.12</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.576</span> ms</span><br><span class="line"></span><br><span class="line">node3：访问node2主机</span><br><span class="line">[root@node3 ~]<span class="comment"># ping 172.16.0.254</span></span><br><span class="line">PING <span class="number">172.16</span>.<span class="number">0.254</span> (<span class="number">172.16</span>.<span class="number">0.254</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line">From <span class="number">10.1</span>.<span class="number">1.1</span>: icmp_seq=<span class="number">1</span> Redirect Host(New nexthop: <span class="number">172.16</span>.<span class="number">0.254</span>)</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.16</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">63</span> time=<span class="number">19.5</span> ms</span><br><span class="line">From <span class="number">10.1</span>.<span class="number">1.1</span>: icmp_seq=<span class="number">2</span> Redirect Host(New nexthop: <span class="number">172.16</span>.<span class="number">0.254</span>)</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.16</span>.<span class="number">0.254</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">63</span> time=<span class="number">1.45</span> ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">node2和node3的网关必须指向node1的ip而不是网关。</span><br></pre></td></tr></table></figure>
<h2 id="Iptables防火墙"><a href="#Iptables防火墙" class="headerlink" title="Iptables防火墙"></a>Iptables防火墙</h2><h3 id="一、防火墙介绍"><a href="#一、防火墙介绍" class="headerlink" title="一、防火墙介绍"></a>一、防火墙介绍</h3><ul>
<li>防火墙分类和作用<ul>
<li>硬件防火墙</li>
<li>软件防火墙</li>
</ul>
</li>
</ul>
<p><img src="/2018/09/12/iptables简单入门/firewall.jpg" alt="firewall"></p>
<p><strong>作用：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">防火墙作为内部网与外部网之间的一种访问控制设备， 常常安装在内部网络和外部网络的边际上。防火墙具有很好的网络安全保护作用。入侵者必须首先穿越防火墙的安全防线，才能接触目标计算机。你可以将防火墙配置成许多不同保护级别。高级别的保护可能会禁止一些服务，如视频流等，但至少这是你自己的保护选择。</span><br><span class="line"></span><br><span class="line">主要作用：</span><br><span class="line">1、Internet防火墙可以防止Internet上的危险传播到网络内部；</span><br><span class="line">2、能强化安全策略;</span><br><span class="line">3、能有效记录Internet上的活动;</span><br></pre></td></tr></table></figure>
<h3 id="二、Iptables防火墙介绍"><a href="#二、Iptables防火墙介绍" class="headerlink" title="二、Iptables防火墙介绍"></a>二、Iptables防火墙介绍</h3><ul>
<li>Linux系统内核集成了网络访问控制的功能，通过netfilter模块来实现，是内核的一部分（内核空间）</li>
<li>用户层（用户空间）可以通过iptables程序对netfilter进行控制管理，进而实现网络的访问控制</li>
<li>TCP_Wrappers 也是一个网络访问控制的一个工具，作用在应用层（7层防火墙）</li>
</ul>
<p><strong>总结：</strong></p>
<ul>
<li>netfilter模块        内核空间，是内核一部分 </li>
<li>iptables组件  用户空间，提供管理防火墙的手段，它主要作用在传输层（4层防火墙）</li>
</ul>
<h3 id="三、Iptables防火墙结构"><a href="#三、Iptables防火墙结构" class="headerlink" title="三、Iptables防火墙结构"></a>三、Iptables防火墙结构</h3><ul>
<li><p><strong>四张表</strong></p>
<ul>
<li><strong>filter:</strong>实现对数据包的过滤</li>
</ul>
</li>
<li><p><strong>nat:</strong>主要修改数据包的地址和端口，例如源地址或目标地址</p>
</li>
<li><p>mangle对数据包进行修改，例如给数据包打标记MARK</p>
</li>
<li><p>raw：主要做连接追踪​</p>
</li>
<li><p><strong>五条链</strong></p>
<ul>
<li>PREROUTING</li>
<li>INPUT</li>
<li>OUTPUT</li>
<li>FORWARD</li>
<li>POSTROUTING</li>
</ul>
</li>
<li><p><strong>总结：</strong></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">防火墙是表的集合，表示链的集合，链式规则的集合</span><br></pre></td></tr></table></figure>
<p><img src="/2018/09/12/iptables简单入门/iptable_结构.png" alt="iptable_结构"></p>
<p>​</p>
</li>
</ul>
<h3 id="四、防火墙工作原理（数据包流向）"><a href="#四、防火墙工作原理（数据包流向）" class="headerlink" title="四、防火墙工作原理（数据包流向）"></a>四、防火墙工作原理（数据包流向）</h3><p><img src="/2018/09/12/iptables简单入门/数据包流向.png" alt="数据包流向"></p>
<h3 id="五、Iptables基本语法"><a href="#五、Iptables基本语法" class="headerlink" title="五、Iptables基本语法"></a>五、Iptables基本语法</h3><ul>
<li><p>iptables [-t 表名] 命令选项 ［链名］ [规则号码] ［条件匹配］ ［-j 目标动作]</p>
<p>​                小写      大写          大写                            小写                   大写<br>说明：<br>表名和链名：用于指定 iptables命令所操作的表和链；<br>命令选项：用于指定管理iptables规则的方式（比如：插入、增加、删除、查看等）；<br>规则号吗：用于指定规则的编号；<br>条件匹配：用于指定对符合什么样条件的数据包进行处理（比如：什么协议、出入网卡等）；<br>目标动作：用于指定数据包的处理方式（比如：允许通过、拒绝、丢弃等）</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">iptables -L			</span><br><span class="line">iptables -t <span class="keyword">filter</span> -L	</span><br><span class="line">iptables -t nat -L</span><br><span class="line">iptables -t raw -L</span><br><span class="line">iptables -t mangle -L</span><br></pre></td></tr></table></figure>
<ul>
<li>iptables的启动和关闭以及保存</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//临时停止|启动|查看状态|重新加载|重新启动</span><br><span class="line">service iptables stop|start|status|reload|restart	</span><br><span class="line">//开机是否自启动</span><br><span class="line">chkconfig iptables off|on</span><br><span class="line">//永久保存规则</span><br><span class="line">vim	/etc/sysconfig/iptables</span><br><span class="line">...</span><br><span class="line">增加规则</span><br></pre></td></tr></table></figure>
<ul>
<li>iptables常用的命令选项</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">常见的命令选项：</span><br><span class="line">-L								查看</span><br><span class="line">-A								追加，放置最后一条</span><br><span class="line">-I								插入，默认插入成第一条</span><br><span class="line">-D								删除</span><br><span class="line">-F								清空flush</span><br><span class="line">-P     						    设置默认策略policy</span><br><span class="line"></span><br><span class="line">处理动作：</span><br><span class="line"><span class="keyword">filter</span>表:</span><br><span class="line">-j ACCEPT				允许</span><br><span class="line">-j DROP					丢弃，没有任何提示信息</span><br><span class="line">-j REJECT				拒绝，有提示信息</span><br><span class="line">-j LOG					写日志     /var/log/messages    然后将数据包传递给下一条规则</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nat表:</span><br><span class="line">-j SNAT						源地址转换 POSTROUTING</span><br><span class="line">-j DNAT						目标地址转换 PREROUTING</span><br></pre></td></tr></table></figure>
<h3 id="1-Filter表"><a href="#1-Filter表" class="headerlink" title="1. Filter表"></a>1. <strong><em>Filter表</em></strong></h3><hr>
<h4 id="1-1-示例1：-全部允许-拒绝-丢弃"><a href="#1-1-示例1：-全部允许-拒绝-丢弃" class="headerlink" title="1.1 示例1：(全部允许/拒绝/丢弃)"></a>1.1 示例1：(全部允许/拒绝/丢弃)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -j DROP			添加规则，丢弃所有进来的数据包</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -j ACCEPT		添加规则，允许所有进来的数据包</span><br><span class="line"></span><br><span class="line">//指定位置插入规则，允许所有进来的数据包第<span class="number">1</span>条规则</span><br><span class="line">iptables -t <span class="keyword">filter</span> -I INPUT <span class="number">1</span> -j ACCEPT	  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -j DROP	  添加规则，丢弃所有出去的数据包</span><br><span class="line"></span><br><span class="line">//指定位置插入规则，拒绝所有进来的数据包为第<span class="number">3</span>条规则</span><br><span class="line">iptables -t <span class="keyword">filter</span> -I INPUT <span class="number">3</span> -j REJECT	  </span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -L --line-numbers	  查看规则编号</span><br><span class="line">iptables -t <span class="keyword">filter</span> -R INPUT <span class="number">1</span> -j ACCEPT		覆盖已有规则</span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -D INPUT <span class="number">3</span>			删除INPUT链的第<span class="number">3</span>条规则</span><br><span class="line">iptables -t <span class="keyword">filter</span> -F					清空<span class="keyword">filter</span>表的所有规则</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -j LOG			增加规则，先写日志，然后将数据包传递给下一条规则</span><br><span class="line">iptables -I INPUT <span class="number">2</span> -j DROP			</span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -P INPUT DROP		设置链上的默认规则</span><br><span class="line">iptables -D INPUT <span class="number">1</span></span><br><span class="line"></span><br><span class="line">说明：如果不指定表名，默认操作<span class="keyword">filter</span>表</span><br><span class="line"></span><br><span class="line">课堂练习<span class="number">1</span>：</span><br></pre></td></tr></table></figure>
<h4 id="1-2-示例2：-根据源和目标地址匹配"><a href="#1-2-示例2：-根据源和目标地址匹配" class="headerlink" title="1.2 示例2：(根据源和目标地址匹配)"></a>1.2 示例2：(根据源和目标地址匹配)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">匹配的条件：</span><br><span class="line">-s <span class="number">192.168</span>.<span class="number">134.0</span>/<span class="number">24</span>   	 	源地址</span><br><span class="line">-d <span class="number">192.168</span>.<span class="number">134.1</span>	    	目标地址</span><br><span class="line">-p tcp|upd|icmp		    	协议</span><br><span class="line">-i  lo		    			input 从lo接口进入的数据包</span><br><span class="line">-o eth0             		 output 从eth0出去的数据包</span><br><span class="line">-p tcp --dport <span class="number">80</span>   	    目标端口是<span class="number">80</span>,必须和-p tcp|udp 连用</span><br><span class="line">-p udp --dport <span class="number">53</span>   	    目标端口是<span class="number">53</span>/udp</span><br></pre></td></tr></table></figure>
<p>思考：什么是源地址和目标地址？</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -s <span class="number">10.1</span>.<span class="number">1.3</span> -j ACCEPT		允许源地址为<span class="number">10.1</span>.<span class="number">1.3</span>进入</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT ! -s <span class="number">10.1</span>.<span class="number">1.3</span> -j ACCEPT		不允许源地址为<span class="number">10.1</span>.<span class="number">1.3</span>进入</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -s <span class="number">10.1</span>.<span class="number">1.3</span> -j DROP			拒绝源地址为<span class="number">10.1</span>.<span class="number">1.3</span>进入</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -d <span class="number">10.1</span>.<span class="number">1.3</span> -j DROP	丢弃到达目标地址为<span class="number">10.1</span>.<span class="number">1.3</span>的包</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT ! -d <span class="number">10.1</span>.<span class="number">1.3</span> -j ACCEPT  丢弃到达目标地址为<span class="number">10.1</span>.<span class="number">1.3</span>的包</span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -d <span class="number">10.1</span>.<span class="number">1.2</span> -j DROP		丢弃所有到目标地址<span class="number">10.1</span>.<span class="number">1.2</span>的包	</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -j ACCEPT	源地址为<span class="number">10.1</span>.<span class="number">1.2</span>出去的包全部允许</span><br><span class="line"></span><br><span class="line">课堂练习<span class="number">2</span>：</span><br><span class="line">禁止你的另外一台服务器访问你（INPUT和OUTPUT）</span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -j DROP</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -d <span class="number">10.1</span>.<span class="number">1.2</span> -j DROP</span><br><span class="line"></span><br><span class="line">//以下规则拒绝了所有人的访问</span><br><span class="line">[root@server ~]<span class="comment"># iptables -t filter -A INPUT -d 10.1.1.1 -j DROP</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -t filter -A OUTPUT -s 10.1.1.1 -j DROP</span></span><br></pre></td></tr></table></figure>
<h4 id="1-3-示例3：-根据协议匹配过滤"><a href="#1-3-示例3：-根据协议匹配过滤" class="headerlink" title="1.3 示例3：(根据协议匹配过滤)"></a>1.3 示例3：(根据协议匹配过滤)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptableS -A INPUT -s <span class="number">10.1</span>.<span class="number">1.3</span> -p icmp -j DROP</span><br><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.3</span> -p tcp -j DROP</span><br><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.3</span> ! -p tcp -j DROP</span><br><span class="line"></span><br><span class="line">icmp协议中：</span><br><span class="line">icmp-type <span class="number">8</span> 类型为<span class="number">8</span>代表请求回显，ping请求</span><br><span class="line">icmp-type <span class="number">0</span> 类型为<span class="number">0</span>代表回显应答，ping应答</span><br><span class="line"></span><br><span class="line">需求<span class="number">1</span>：只允许自己ping通别人，不允许别人ping通自己</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -p icmp --icmp-type <span class="number">8</span> -j ACCEPT</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -p icmp --icmp-type <span class="number">0</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line">需求<span class="number">2</span>：只允许自己和<span class="number">10.1</span>.<span class="number">1.2</span>相互ping通，其他人不能ping通自己，但是允许自己ping通别人</span><br><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p icmp --icmp-type <span class="number">8</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="1-4-示例4：-根据端口匹配过滤"><a href="#1-4-示例4：-根据端口匹配过滤" class="headerlink" title="1.4 示例4：(根据端口匹配过滤)"></a>1.4 示例4：(根据端口匹配过滤)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp --dport <span class="number">80</span> -j ACCEPT</span><br><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp --dport <span class="number">20</span>:<span class="number">21</span> -j ACCEPT</span><br><span class="line">iptables -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">课堂练习<span class="number">3</span>：</span><br><span class="line"><span class="number">1</span>. 禁止你的另外一台服务器访问你的<span class="number">80</span>端口，在INPUT和OUTPUT</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 只允许别人访问你的<span class="number">80</span>端口</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 拒绝所有人登录你的sshd服务</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 只允许你可以ping通另外一台主机，但是不允许它ping通你</span><br><span class="line">INPUT 默认策略：DROP</span><br><span class="line">OUTPUT 默认：DROP</span><br><span class="line"></span><br><span class="line">icmp  --icmp-type <span class="number">8</span>   OUTPUT</span><br><span class="line">icmp  --icmp-type <span class="number">0</span>   INPUT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iptables -t <span class="keyword">filter</span> -A OUTPUT -p icmp --icmp-type <span class="number">8</span> -d <span class="number">10.1</span>.<span class="number">1.2</span> -j ACCEPT</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -p icmp --icmp-type <span class="number">0</span> -s <span class="number">10.1</span>.<span class="number">1.2</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="1-5-iptables内置模块（扩展）"><a href="#1-5-iptables内置模块（扩展）" class="headerlink" title="1.5 iptables内置模块（扩展）"></a>1.5 iptables内置模块（扩展）</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">-m 参数+ &lt;模块名&gt;</span><br><span class="line"><span class="number">1</span>. multiport  多端口    目的：指定多个不连续的端口，减少iptables的条目，达到优化效果</span><br><span class="line">用法：</span><br><span class="line">iptables -m multiport --help</span><br><span class="line">-m multiport </span><br><span class="line">		--dports port[,port:port,port...]</span><br><span class="line">		--sports port[,port:port,port...]</span><br><span class="line">示例：</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line">iptables -t <span class="keyword">filter</span> -A INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp --dport <span class="number">80</span> -j ACCEPT</span><br><span class="line">等于</span><br><span class="line">iptables -t <span class="keyword">filter</span> -I INPUT -s <span class="number">10.1</span>.<span class="number">1.2</span> -p tcp -m multiport --dports <span class="number">22</span>,<span class="number">80</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. iprange	ip范围</span><br><span class="line">用法：</span><br><span class="line">iptable -m iprange --help</span><br><span class="line">-m iprange</span><br><span class="line">		--src-range ip[-ip]</span><br><span class="line">		--dst-range ip[-ip]</span><br><span class="line">		</span><br><span class="line">iprange match options:</span><br><span class="line">[!] --src-range ip[-ip]    Match source IP <span class="keyword">in</span> the specified range</span><br><span class="line">[!] --dst-range ip[-ip]    Match destination IP <span class="keyword">in</span> the specified range</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptable -t <span class="keyword">filter</span> -A INPUT -m iprange --src-range <span class="number">10.1</span>.<span class="number">1.2</span>-<span class="number">10.1</span>.<span class="number">1.5</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. state   连接状态		目的：根据连接请求的状态进行数据过滤</span><br><span class="line">状态值：</span><br><span class="line">NEW:			首次访问，比如：打开网站看到首页文件，后续点击叫后续操作</span><br><span class="line">ESTABLISHED:	连接完成  <span class="number">1</span>)某服务的后续所有访问	<span class="number">2</span>)服务器的所有响应	</span><br><span class="line">RELATED:		相关联的连接，比如ftp连接，命令连接成功后，建立数据连接</span><br><span class="line">INVALID:		无效链接</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A OUTPUT -p tcp -m multiport --sports <span class="number">20</span>:<span class="number">22</span>,<span class="number">80</span>,<span class="number">137</span>,<span class="number">445</span> -j ACCEPT</span><br><span class="line">等于</span><br><span class="line">iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="1-6-综合案例"><a href="#1-6-综合案例" class="headerlink" title="1.6 综合案例"></a>1.6 综合案例</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">环境：</span><br><span class="line">server:<span class="number">10.1</span>.<span class="number">1.1</span>		部署了FTP服务，httpd服务，samba服务，ssh服务</span><br><span class="line">client1:<span class="number">10.1</span>.<span class="number">1.2</span>	</span><br><span class="line">client2:<span class="number">10.1</span>.<span class="number">1.3</span>	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">要求：</span><br><span class="line"><span class="number">1</span>. server端根据权限最小化原则，INPUT的默认规则改为DROP</span><br><span class="line"><span class="number">2</span>. client2可以访问server端的所有服务</span><br><span class="line"><span class="number">3</span>. client1只能访问server端的ftp服务和ssh服务</span><br><span class="line"><span class="number">4</span>. IP地址为<span class="number">10.1</span>.<span class="number">1.100</span>到<span class="number">10.1</span>.<span class="number">1.200</span>之间的人只能访问server端的samba服务</span><br></pre></td></tr></table></figure>
<p>具体步骤：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">首先，server端部署相关服务并启动</span><br><span class="line">//查看相应的软件包是否成功安装，没安装请安装它</span><br><span class="line">[root@server ~]<span class="comment"># rpm -q vsftpd httpd samba openssh-server</span></span><br><span class="line">vsftpd-<span class="number">2.2</span>.<span class="number">2</span>-<span class="number">11</span>.el6_4.<span class="number">1</span>.x86_64</span><br><span class="line">httpd-<span class="number">2.2</span>.<span class="number">15</span>-<span class="number">29</span>.el6.centos.x86_64</span><br><span class="line">samba-<span class="number">3.6</span>.<span class="number">9</span>-<span class="number">164</span>.el6.x86_64</span><br><span class="line">openssh-server-<span class="number">5.3</span>p1-<span class="number">94</span>.el6.x86_64</span><br><span class="line"></span><br><span class="line">//启动相应的服务</span><br><span class="line">[root@server ~]<span class="comment"># service vsftpd start</span></span><br><span class="line">[root@server ~]<span class="comment"># service httpd restart</span></span><br><span class="line">[root@server ~]<span class="comment"># service nmb start</span></span><br><span class="line">[root@server ~]<span class="comment"># service smb start</span></span><br><span class="line">[root@server ~]<span class="comment"># service sshd restart</span></span><br><span class="line"></span><br><span class="line">//检查端口是否处于监听状态</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># netstat -anltp|grep vsftpd				tcp/21号端口</span></span><br><span class="line">[root@server ~]<span class="comment"># netstat -anltp|grep httpd				tcp/80号端口</span></span><br><span class="line">[root@server ~]<span class="comment"># netstat -anltp|grep smb				tcp/139,445号端口</span></span><br><span class="line">[root@server ~]<span class="comment"># netstat -anltp|grep sshd				tcp/22号端口</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. server端根据权限最小化原则，INPUT链的默认规则改为DROP</span><br><span class="line">[root@server ~]<span class="comment"># iptables -F</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -L</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -P INPUT DROP</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -L</span></span><br><span class="line">Chain INPUT (policy DROP)	//默认拒绝	</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)	</span><br><span class="line">target     prot opt source               destination  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. client2可以访问server端的所有服务</span><br><span class="line">                             </span><br><span class="line">[root@server ~]<span class="comment"># iptables -A INPUT -s 10.1.1.3 -d 10.1.1.1 -m multiport -p tcp --dports 20:22,80,139,445 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">//ftp服务比较麻烦，需要固定被动模式下的端口</span><br><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">增加如下内容：</span><br><span class="line">pasv_min_port=<span class="number">2000</span></span><br><span class="line">pasv_max_port=<span class="number">3000</span></span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -A INPUT -d 10.1.1.1 -s 10.1.1.3 -p tcp --sport 2000:3000 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. client1只能访问server端的ftp服务和ssh服务</span><br><span class="line">//client1访问server端的ssh服务，server端规则如下：</span><br><span class="line">[root@server ~]<span class="comment"># iptables -A INPUT -s 10.1.1.2 -d 10.1.1.1 -p tcp --dport 22 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">注意：此时server如果不能远程访问client1主机，解决方案如下：</span><br><span class="line">则需要再添加如下规则：</span><br><span class="line">[root@server ~]<span class="comment"># iptables -A INPUT -s 10.1.1.2 -d 10.1.1.1 -m state --state ESTABLISHED -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">//client1访问server端ftp服务，server端规则如下：</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -A INPUT -s 10.1.1.2 -d 10.1.1.1 -m multiport -p tcp --dports 20:21,2000:3000 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. IP地址为<span class="number">10.1</span>.<span class="number">1.100</span>到<span class="number">10.1</span>.<span class="number">1.200</span>之间的人只能访问server端的samba服务</span><br><span class="line">iptables -A INPUT -m iprange --src-range <span class="number">10.1</span>.<span class="number">1.100</span>-<span class="number">10.1</span>.<span class="number">1.200</span> -p tcp -m multiport --dports <span class="number">139</span>,<span class="number">445</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>扩展：</p>
<p>FTP服务除了在server端指定被动模式下的随机端口号的范围外，还有没有其他方法实现？</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">方法一： 为vsftpd指定数据端口</span><br><span class="line"><span class="comment"># iptables -I INPUT -p tcp --dport 20:21 -j ACCEPT</span></span><br><span class="line"><span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class="line">pasv_min_port=<span class="number">50000</span></span><br><span class="line">pasv_max_port=<span class="number">60000</span></span><br><span class="line"><span class="comment"># iptables -I INPUT -p tcp --dport 50000:60000 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">方法二： 使用连接追踪模块（扩展）</span><br><span class="line">[root@server ~]<span class="comment"># iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -I INPUT -p tcp --dport 20:21 -j ACCEPT  	</span></span><br><span class="line">[root@server ~]<span class="comment"># modprobe nf_conntrack_ftp					//加载连接追踪模块（临时）</span></span><br><span class="line">[root@server ~]<span class="comment"># vim /etc/sysconfig/iptables-config		//开机自动加载</span></span><br><span class="line">IPTABLES_MODULES=<span class="string">"nf_conntrack_ftp"</span></span><br><span class="line"></span><br><span class="line">nf_conntrack_ftp: 针对数据端口连接时，将三次握手第一次的状态由NEW识别成RELATED</span><br><span class="line"></span><br><span class="line">注意：修改完配置文件需要重启防火墙</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">以下策略ftp服务也可以正常访问：</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -nL</span></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     all  --  <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>            <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>           state NEW,RELATED,ESTABLISHED </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy DROP)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     all  --  <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>            <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>           state ESTABLISHED</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># vim /etc/sysconfig/iptables-config </span></span><br><span class="line">。。。</span><br><span class="line">IPTABLES_MODULES=<span class="string">"nf_conntrack_ftp"</span></span><br><span class="line"></span><br><span class="line">重启防火墙</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -F</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -nL</span></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy DROP)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -t filter -A INPUT -p tcp --dport 20:21 -j ACCEPT</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -t filter -A OUTPUT -m state --state ESTABLISHED -j ACCEPT</span></span><br><span class="line">[root@server ~]<span class="comment"># iptables -nL</span></span><br><span class="line"></span><br><span class="line">结果只能访问，但是不能查看数据</span><br><span class="line"></span><br><span class="line">[root@server ~]<span class="comment"># iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">常见协议的端口 /etc/services</span><br><span class="line">[root@hou ~]<span class="comment"># grep ^http /etc/services</span></span><br><span class="line">服务		协议				端口/传输协议</span><br><span class="line">sshd		ssh			    <span class="number">22</span>/tcp</span><br><span class="line">httpd   	http				<span class="number">80</span>/tcp</span><br><span class="line">			https			    <span class="number">443</span>/tcp</span><br><span class="line">dns			domain		    <span class="number">53</span>/udp,<span class="number">53</span>/tcp</span><br><span class="line">mail		smtp			    <span class="number">25</span>/tcp				</span><br><span class="line">			smtps       	    <span class="number">465</span>/tcp         	</span><br><span class="line">			pop3			    <span class="number">110</span>/tcp			</span><br><span class="line">			pop3s			<span class="number">995</span>/tcp</span><br><span class="line">			imap			    <span class="number">143</span>/tcp</span><br><span class="line">			imaps			<span class="number">993</span>/tcp</span><br><span class="line">dhcp		bootps      	    <span class="number">67</span>/udp          </span><br><span class="line">nfs			nfs				<span class="number">2049</span>/tcp</span><br><span class="line">samba						<span class="number">137</span>,<span class="number">138</span>,<span class="number">139</span>/tcp</span><br><span class="line">								<span class="number">445</span>/tcp</span><br><span class="line">ftp		    ftp				    <span class="number">21</span>/tcp</span><br><span class="line">		    ftp-data		    <span class="number">20</span>/tcp</span><br><span class="line">tftp       	tftp               <span class="number">69</span>/udp</span><br><span class="line">ntp       	ntp				<span class="number">123</span>/udp   </span><br><span class="line">syslog		syslog			<span class="number">514</span>/udp</span><br></pre></td></tr></table></figure>
<h3 id="2-Nat表"><a href="#2-Nat表" class="headerlink" title="2. Nat表"></a>2. Nat表</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">功能：地址转换 （源地址和目标地址）</span><br><span class="line"></span><br><span class="line">三条链：</span><br><span class="line">PREROUTING</span><br><span class="line">POSTROUTING</span><br><span class="line">OUTPUT</span><br><span class="line"></span><br><span class="line">处理动作</span><br><span class="line">nat表:</span><br><span class="line">-j SNAT						源地址转换 POSTROUTING</span><br><span class="line">-j DNAT						目标地址转换 PREROUTING</span><br><span class="line">-j MASQUERADE				 地址伪装</span><br></pre></td></tr></table></figure>
<h4 id="2-1-地址转换应用场景"><a href="#2-1-地址转换应用场景" class="headerlink" title="2.1 地址转换应用场景"></a>2.1 地址转换应用场景</h4><ul>
<li><p>公司内部员工访问互联网        SNAT</p>
</li>
<li><p>互联网用户访问公司服务器         DNAT</p>
</li>
</ul>
<h4 id="2-2-地址转换应用"><a href="#2-2-地址转换应用" class="headerlink" title="2.2 地址转换应用"></a>2.2 地址转换应用</h4><h5 id="2-2-1-源地址转换—SNAT"><a href="#2-2-1-源地址转换—SNAT" class="headerlink" title="2.2.1 源地址转换—SNAT"></a>2.2.1 源地址转换—SNAT</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">环境：</span><br><span class="line">client：<span class="number">10.1</span>.<span class="number">1.2</span></span><br><span class="line">nat-server:<span class="number">10.1</span>.<span class="number">1.1</span> 和 <span class="number">2.2</span>.<span class="number">2.1</span></span><br><span class="line">web-server:<span class="number">2.2</span>.<span class="number">2.2</span></span><br><span class="line"></span><br><span class="line">需求：</span><br><span class="line">客户端client是私有IP,想要访问互联网中的web服务</span><br><span class="line"></span><br><span class="line">步骤：</span><br><span class="line"><span class="number">1</span>. client端：设置自己的默认路由（网关）指向nat-server服务器</span><br><span class="line">[root@client ~]<span class="comment"># route add default gw 10.1.1.1</span></span><br><span class="line">[root@client ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">10.1</span>.<span class="number">1.0</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">1</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"><span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">10.1</span>.<span class="number">1.1</span>        <span class="number">0.0</span>.<span class="number">0.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. nat-server端：开启路由转发功能并添加防火墙规则</span><br><span class="line">[root@nat-server ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_forward </span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">[root@nat-server ~]<span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line"></span><br><span class="line">[root@nat-server ~]<span class="comment"># iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -j SNAT --to 2.2.2.1</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. web-server端：搭建web服务</span><br><span class="line">[root@web-server ~]<span class="comment"># echo "this is snat test page" &gt; /var/www/html/index.html</span></span><br><span class="line">[root@web-server ~]<span class="comment"># service httpd restart</span></span><br><span class="line"></span><br><span class="line">[root@web-server ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">2.2</span>.<span class="number">2.0</span>         <span class="number">0.0</span>.<span class="number">0.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>   U     <span class="number">1</span>      <span class="number">0</span>        <span class="number">0</span> eth0</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. client端测试验证：client端<span class="number">10.1</span>.<span class="number">1.2</span>是否可以访问web-server端<span class="number">2.2</span>.<span class="number">2.2</span>的web服务</span><br><span class="line"></span><br><span class="line">[root@client ~]<span class="comment"># elinks --dump http://2.2.2.2</span></span><br><span class="line">   this is snat test page</span><br><span class="line"></span><br><span class="line">思考<span class="number">1</span>：家里实现上网和上面有什么不同？</span><br><span class="line"></span><br><span class="line">[root@nat-server ~]<span class="comment"># iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -j MASQUERADE</span></span><br><span class="line"></span><br><span class="line">思考<span class="number">2</span>：地址转换是在NAT表上进行，如果我在nat-server上的<span class="keyword">filter</span>的FORWARD链拒绝转发，是否可以正常访问？</span><br></pre></td></tr></table></figure>
<p><strong>总结：</strong></p>
<ol>
<li>SNAT源地址转换目的实现私网地址可以访问互联网</li>
<li>NAT设备可以是硬件防火墙、路由器等物理设备，但是都得具有路由和地址转换功能</li>
<li>当请求发送到NAT设备后，NAT设备首先查看自己的路由表，然后再进行地址转换，所以应该在NAT表的POSTROUTING链上进行源地址转换（路由后）</li>
<li>对于NAT表和FILTER表来说，数据包进来先经过NAT表的PREROUTING链，再过路由表，再选择不同的路出去</li>
</ol>
<h5 id="2-2-2-目标地址转换—DNAT"><a href="#2-2-2-目标地址转换—DNAT" class="headerlink" title="2.2.2 目标地址转换—DNAT"></a>2.2.2 目标地址转换—DNAT</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">环境：</span><br><span class="line">web-server：<span class="number">10.1</span>.<span class="number">1.3</span></span><br><span class="line">nat-server:<span class="number">10.1</span>.<span class="number">1.1</span> 和 <span class="number">2.2</span>.<span class="number">2.1</span></span><br><span class="line">client:<span class="number">2.2</span>.<span class="number">2.2</span></span><br><span class="line"></span><br><span class="line">需求：公网用户client访问私网服务器提供的WEB服务</span><br><span class="line"></span><br><span class="line">步骤：</span><br><span class="line"><span class="number">1</span>. web-server端：<span class="number">10.1</span>.<span class="number">1.3</span>上搭建web服务</span><br><span class="line"><span class="number">2</span>. nat-server端：<span class="number">10.1</span>.<span class="number">1.1</span>、<span class="number">2.2</span>.<span class="number">2.1</span>端开启路由转发功能并添加DNAT规则</span><br><span class="line">[root@nat-server ~]<span class="comment"># iptables -t nat -A PREROUTING -d 2.2.2.1 -p tcp --dport 80 -j DNAT --to 10.1.1.3</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. client端：<span class="number">2.2</span>.<span class="number">2.2</span>客户端测试验证</span><br><span class="line">[root@client ~]<span class="comment"># elinks --dump http://2.2.2.1</span></span><br><span class="line">   this is dnat test page</span><br></pre></td></tr></table></figure>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者: <a href="http://www.bro-camper.top">Camper</a>
            <p>原文链接: <a href="http://www.bro-camper.top/2018/09/12/iptables简单入门/">http://www.bro-camper.top/2018/09/12/iptables简单入门/</a>
            <p>发表日期: <a href="http://www.bro-camper.top/2018/09/12/iptables简单入门/">September 12th 2018, 10:52:35 pm</a>
            <p>版权声明: 本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2018/09/12/网络基础/" title= 网络基础 >
                    <div class="nextTitle">网络基础</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2018/09/12/持续集成-gitlab/" title= 持续集成-gitlab >
                    <div class="prevTitle">持续集成-gitlab</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!--PC和WAP自适应版-->

    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:Bro-camper@outlook.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="http://github.com/Bro-camper" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                  
                  <img class="profile-qr" src="/assets/wechat.png" />
                </span>
            
        
    
        
            
                <span class="iconfont-archer qq" title=qq>
                  
                  <img class="profile-qr" src="/assets/qq.png" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo 
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>  -->
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#预热：请看上一篇–网络基础"><span class="toc-number">1.</span> <span class="toc-text">预热：请看上一篇–网络基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、查看路由表信息"><span class="toc-number">1.1.</span> <span class="toc-text">一、查看路由表信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、IP路由选择实验"><span class="toc-number">1.2.</span> <span class="toc-text">二、IP路由选择实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-route相关命令"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. route相关命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-实验需求"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 实验需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-具体步骤"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 具体步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iptables防火墙"><span class="toc-number">2.</span> <span class="toc-text">Iptables防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、防火墙介绍"><span class="toc-number">2.1.</span> <span class="toc-text">一、防火墙介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、Iptables防火墙介绍"><span class="toc-number">2.2.</span> <span class="toc-text">二、Iptables防火墙介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、Iptables防火墙结构"><span class="toc-number">2.3.</span> <span class="toc-text">三、Iptables防火墙结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、防火墙工作原理（数据包流向）"><span class="toc-number">2.4.</span> <span class="toc-text">四、防火墙工作原理（数据包流向）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#五、Iptables基本语法"><span class="toc-number">2.5.</span> <span class="toc-text">五、Iptables基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Filter表"><span class="toc-number">2.6.</span> <span class="toc-text">1. Filter表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-示例1：-全部允许-拒绝-丢弃"><span class="toc-number">2.6.1.</span> <span class="toc-text">1.1 示例1：(全部允许/拒绝/丢弃)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-示例2：-根据源和目标地址匹配"><span class="toc-number">2.6.2.</span> <span class="toc-text">1.2 示例2：(根据源和目标地址匹配)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-示例3：-根据协议匹配过滤"><span class="toc-number">2.6.3.</span> <span class="toc-text">1.3 示例3：(根据协议匹配过滤)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-示例4：-根据端口匹配过滤"><span class="toc-number">2.6.4.</span> <span class="toc-text">1.4 示例4：(根据端口匹配过滤)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-iptables内置模块（扩展）"><span class="toc-number">2.6.5.</span> <span class="toc-text">1.5 iptables内置模块（扩展）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-综合案例"><span class="toc-number">2.6.6.</span> <span class="toc-text">1.6 综合案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Nat表"><span class="toc-number">2.7.</span> <span class="toc-text">2. Nat表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-地址转换应用场景"><span class="toc-number">2.7.1.</span> <span class="toc-text">2.1 地址转换应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-地址转换应用"><span class="toc-number">2.7.2.</span> <span class="toc-text">2.2 地址转换应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-源地址转换—SNAT"><span class="toc-number">2.7.2.1.</span> <span class="toc-text">2.2.1 源地址转换—SNAT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-目标地址转换—DNAT"><span class="toc-number">2.7.2.2.</span> <span class="toc-text">2.2.2 目标地址转换—DNAT</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 5
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2018/09/12/iptables简单入门/" >iptables简单入门</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2018/09/12/网络基础/" >网络基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2018/09/12/持续集成-gitlab/" >持续集成-gitlab</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2018/09/12/tomcat性能优化/" >tomcat性能优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2018/09/12/持续集成-jenkins（上）/" >持续集成-jenkins（上）</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "Camper"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


